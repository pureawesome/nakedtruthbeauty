!function(t){Drupal.behaviors.tableDrag={attach:function(e,r){for(var a in r.tableDrag)t("#"+a,e).once("tabledrag",function(){Drupal.tableDrag[a]=new Drupal.tableDrag(this,r.tableDrag[a])})}},Drupal.tableDrag=function(e,r){var a=this;this.table=e,this.tableSettings=r,this.dragObject=null,this.rowObject=null,this.oldRowElement=null,this.oldY=0,this.changed=!1,this.maxDepth=0,this.rtl="rtl"==t(this.table).css("direction")?-1:1,this.scrollSettings={amount:4,interval:50,trigger:70},this.scrollInterval=null,this.scrollY=0,this.windowHeight=0,this.indentEnabled=!1;for(var n in r)for(var i in r[n])"parent"==r[n][i].relationship&&(this.indentEnabled=!0),r[n][i].limit>0&&(this.maxDepth=r[n][i].limit);if(this.indentEnabled){this.indentCount=1;var o=Drupal.theme("tableDragIndentation"),l=t("<tr/>").addClass("draggable").appendTo(e),s=t("<td/>").appendTo(l).prepend(o).prepend(o);this.indentAmount=t(".indentation",s).get(1).offsetLeft-t(".indentation",s).get(0).offsetLeft,l.remove()}t("> tr.draggable, > tbody > tr.draggable",e).each(function(){a.makeDraggable(this)}),t(e).before(t('<a href="#" class="tabledrag-toggle-weight"></a>').attr("title",Drupal.t("Re-order rows by numerical weight instead of dragging.")).click(function(){return 1==t.cookie("Drupal.tableDrag.showWeight")?a.hideColumns():a.showColumns(),!1}).wrap('<div class="tabledrag-toggle-weight-wrapper"></div>').parent()),a.initColumns(),t(document).bind("mousemove pointermove",function(t){return a.dragRow(t,a)}),t(document).bind("mouseup pointerup",function(t){return a.dropRow(t,a)}),t(document).bind("touchmove",function(t){return a.dragRow(t.originalEvent.touches[0],a)}),t(document).bind("touchend",function(t){return a.dropRow(t.originalEvent.touches[0],a)})},Drupal.tableDrag.prototype.initColumns=function(){for(var e in this.tableSettings){for(var r in this.tableSettings[e]){var a=t("."+this.tableSettings[e][r].target+":first",this.table);if(a.length&&this.tableSettings[e][r].hidden){var n=this.tableSettings[e][r].hidden,i=a.closest("td");break}}if(n&&i[0]){var o=t("> td",i.parent()).index(i.get(0))+1;t("> thead > tr, > tbody > tr, > tr",this.table).each(function(){var e=o,r=t(this).children();r.each(function(t){t<e&&this.colSpan&&this.colSpan>1&&(e-=this.colSpan-1)}),e>0&&(i=r.filter(":nth-child("+e+")"),i[0].colSpan&&i[0].colSpan>1?i.addClass("tabledrag-has-colspan"):i.addClass("tabledrag-hide"))})}}null===t.cookie("Drupal.tableDrag.showWeight")?(t.cookie("Drupal.tableDrag.showWeight",0,{path:Drupal.settings.basePath,expires:365}),this.hideColumns()):1==t.cookie("Drupal.tableDrag.showWeight")?this.showColumns():this.hideColumns()},Drupal.tableDrag.prototype.hideColumns=function(){t(".tabledrag-hide","table.tabledrag-processed").css("display","none"),t(".tabledrag-handle","table.tabledrag-processed").css("display",""),t(".tabledrag-has-colspan","table.tabledrag-processed").each(function(){this.colSpan=this.colSpan-1}),t(".tabledrag-toggle-weight").text(Drupal.t("Show row weights")),t.cookie("Drupal.tableDrag.showWeight",0,{path:Drupal.settings.basePath,expires:365}),t("table.tabledrag-processed").trigger("columnschange","hide")},Drupal.tableDrag.prototype.showColumns=function(){t(".tabledrag-hide","table.tabledrag-processed").css("display",""),t(".tabledrag-handle","table.tabledrag-processed").css("display","none"),t(".tabledrag-has-colspan","table.tabledrag-processed").each(function(){this.colSpan=this.colSpan+1}),t(".tabledrag-toggle-weight").text(Drupal.t("Hide row weights")),t.cookie("Drupal.tableDrag.showWeight",1,{path:Drupal.settings.basePath,expires:365}),t("table.tabledrag-processed").trigger("columnschange","show")},Drupal.tableDrag.prototype.rowSettings=function(e,r){var a=t("."+e,r);for(var n in this.tableSettings[e]){var i=this.tableSettings[e][n].target;if(a.is("."+i)){var o={};for(var l in this.tableSettings[e][n])o[l]=this.tableSettings[e][n][l];return o}}},Drupal.tableDrag.prototype.makeDraggable=function(e){var r=this,a=t('<a href="#" class="tabledrag-handle"><div class="handle">&nbsp;</div></a>').attr("title",Drupal.t("Drag to re-order"));t("td:first .indentation:last",e).length?(t("td:first .indentation:last",e).after(a),r.indentCount=Math.max(t(".indentation",e).length,r.indentCount)):t("td:first",e).prepend(a),a.hover(function(){null==r.dragObject?t(this).addClass("tabledrag-handle-hover"):null},function(){null==r.dragObject?t(this).removeClass("tabledrag-handle-hover"):null}),a.bind("mousedown touchstart pointerdown",function(a){return"touchstart"==a.originalEvent.type&&(a=a.originalEvent.touches[0]),r.dragObject={},r.dragObject.initMouseOffset=r.getMouseOffset(e,a),r.dragObject.initMouseCoords=r.mouseCoords(a),r.indentEnabled&&(r.dragObject.indentMousePos=r.dragObject.initMouseCoords),r.rowObject&&t("a.tabledrag-handle",r.rowObject.element).blur(),r.rowObject=new r.row(e,"mouse",r.indentEnabled,r.maxDepth,!0),r.table.topY=t(r.table).offset().top,r.table.bottomY=r.table.topY+r.table.offsetHeight,t(this).addClass("tabledrag-handle-hover"),t(e).addClass("drag"),t("body").addClass("drag"),r.oldRowElement&&t(r.oldRowElement).removeClass("drag-previous"),navigator.userAgent.indexOf("MSIE 6.")!=-1&&t("select",this.table).css("display","none"),r.safeBlur=!1,r.onDrag(),!1}),a.click(function(){return!1}),a.focus(function(){t(this).addClass("tabledrag-handle-hover"),r.safeBlur=!0}),a.blur(function(e){t(this).removeClass("tabledrag-handle-hover"),r.rowObject&&r.safeBlur&&r.dropRow(e,r)}),a.keydown(function(n){9==n.keyCode||r.rowObject||(r.rowObject=new r.row(e,"keyboard",r.indentEnabled,r.maxDepth,!0));var i=!1;switch(n.keyCode){case 37:case 63234:i=!0,r.rowObject.indent(-1*r.rtl);break;case 38:case 63232:for(var o=t(r.rowObject.element).prev("tr").get(0);o&&t(o).is(":hidden");)o=t(o).prev("tr").get(0);if(o){if(r.safeBlur=!1,r.rowObject.direction="up",i=!0,t(e).is(".tabledrag-root")){for(var l=0;o&&t(".indentation",o).length;)o=t(o).prev("tr").get(0),l+=t(o).is(":hidden")?0:o.offsetHeight;o&&(r.rowObject.swap("before",o),window.scrollBy(0,-l))}else(r.table.tBodies[0].rows[0]!=o||t(o).is(".draggable"))&&(r.rowObject.swap("before",o),r.rowObject.interval=null,r.rowObject.indent(0),window.scrollBy(0,-parseInt(e.offsetHeight,10)));a.get(0).focus()}break;case 39:case 63235:i=!0,r.rowObject.indent(1*r.rtl);break;case 40:case 63233:for(var s=t(r.rowObject.group).filter(":last").next("tr").get(0);s&&t(s).is(":hidden");)s=t(s).next("tr").get(0);if(s){if(r.safeBlur=!1,r.rowObject.direction="down",i=!0,t(e).is(".tabledrag-root")){var l=0,d=new r.row(s,"keyboard",r.indentEnabled,r.maxDepth,!1);if(d){t(d.group).each(function(){l+=t(this).is(":hidden")?0:this.offsetHeight});var h=t(d.group).filter(":last").get(0);r.rowObject.swap("after",h),window.scrollBy(0,parseInt(l,10))}}else r.rowObject.swap("after",s),r.rowObject.interval=null,r.rowObject.indent(0),window.scrollBy(0,parseInt(e.offsetHeight,10));a.get(0).focus()}}if(r.rowObject&&1==r.rowObject.changed&&(t(e).addClass("drag"),r.oldRowElement&&t(r.oldRowElement).removeClass("drag-previous"),r.oldRowElement=e,r.restripeTable(),r.onDrag()),i)return!1}),a.keypress(function(t){switch(t.keyCode){case 37:case 38:case 39:case 40:return!1}})},Drupal.tableDrag.prototype.dragRow=function(t,e){if(e.dragObject){e.currentMouseCoords=e.mouseCoords(t);var r=e.currentMouseCoords.y-e.dragObject.initMouseOffset.y,a=e.currentMouseCoords.x-e.dragObject.initMouseOffset.x;if(r!=e.oldY){e.rowObject.direction=r>e.oldY?"down":"up",e.oldY=r;var n=e.checkScroll(e.currentMouseCoords.y);clearInterval(e.scrollInterval),(n>0&&"down"==e.rowObject.direction||n<0&&"up"==e.rowObject.direction)&&e.setScroll(n);var i=e.findDropTargetRow(a,r);i&&("down"==e.rowObject.direction?e.rowObject.swap("after",i,e):e.rowObject.swap("before",i,e),e.restripeTable())}if(e.indentEnabled){var o=e.currentMouseCoords.x-e.dragObject.indentMousePos.x,l=Math.round(o/e.indentAmount),s=e.rowObject.indent(l);e.dragObject.indentMousePos.x+=e.indentAmount*s*e.rtl,e.indentCount=Math.max(e.indentCount,e.rowObject.indents)}return!1}},Drupal.tableDrag.prototype.dropRow=function(e,r){if(null!=r.rowObject){var a=r.rowObject.element;if(1==r.rowObject.changed){r.updateFields(a);for(var n in r.tableSettings){var i=r.rowSettings(n,a);if("group"==i.relationship)for(var o in r.rowObject.children)r.updateField(r.rowObject.children[o],n)}r.rowObject.markChanged(),0==r.changed&&(t(Drupal.theme("tableDragChangedWarning")).insertBefore(r.table).hide().fadeIn("slow"),r.changed=!0)}r.indentEnabled&&r.rowObject.removeIndentClasses(),r.oldRowElement&&t(r.oldRowElement).removeClass("drag-previous"),t(a).removeClass("drag").addClass("drag-previous"),r.oldRowElement=a,r.onDrop(),r.rowObject=null}null!=r.dragObject&&(t(".tabledrag-handle",a).removeClass("tabledrag-handle-hover"),r.dragObject=null,t("body").removeClass("drag"),clearInterval(r.scrollInterval),navigator.userAgent.indexOf("MSIE 6.")!=-1&&t("select",this.table).css("display","block"))},Drupal.tableDrag.prototype.mouseCoords=function(t){var e=t.clientX||t.originalEvent.clientX,r=t.clientY||t.originalEvent.clientY;return t.pageX||t.pageY?{x:t.pageX,y:t.pageY}:{x:e+document.body.scrollLeft-document.body.clientLeft,y:r+document.body.scrollTop-document.body.clientTop}},Drupal.tableDrag.prototype.getMouseOffset=function(e,r){var a=t(e).offset(),n=this.mouseCoords(r);return{x:n.x-a.left,y:n.y-a.top}},Drupal.tableDrag.prototype.findDropTargetRow=function(e,r){for(var a=t(this.table.tBodies[0].rows).not(":hidden"),n=0;n<a.length;n++){var i=a[n],o=t(i).offset().top;if(0==i.offsetHeight)var l=parseInt(i.firstChild.offsetHeight,10)/2;else var l=parseInt(i.offsetHeight,10)/2;if(r>o-l&&r<o+l){if(this.indentEnabled){for(var n in this.rowObject.group)if(this.rowObject.group[n]==i)return null}else if(i==this.rowObject.element)return null;if(!this.rowObject.isValidSwap(i))return null;for(;t(i).is(":hidden")&&t(i).prev("tr").is(":hidden");)i=t(i).prev("tr").get(0);return i}}return null},Drupal.tableDrag.prototype.updateFields=function(t){for(var e in this.tableSettings)this.updateField(t,e)},Drupal.tableDrag.prototype.updateField=function(e,r){var a=this.rowSettings(r,e);if("self"==a.relationship||"group"==a.relationship)var n=e;else if("sibling"==a.relationship){var i=t(e).prev("tr").get(0),o=t(e).next("tr").get(0),n=e;t(i).is(".draggable")&&t("."+r,i).length?this.indentEnabled?t(".indentations",i).length==t(".indentations",e)&&(n=i):n=i:t(o).is(".draggable")&&t("."+r,o).length&&(this.indentEnabled?t(".indentations",o).length==t(".indentations",e)&&(n=o):n=o)}else if("parent"==a.relationship){for(var i=t(e).prev("tr");i.length&&t(".indentation",i).length>=this.rowObject.indents;)i=i.prev("tr");if(i.length)n=i[0];else{n=t(this.table).find("tr.draggable:first").get(0),n==this.rowObject.element&&(n=t(this.rowObject.group[this.rowObject.group.length-1]).next("tr.draggable").get(0));var l=!0}}this.copyDragClasses(n,e,r),a=this.rowSettings(r,e),l&&(a.relationship="sibling",a.source=a.target);var s="."+a.target,d=t(s,e).get(0);if(d){var h="."+a.source,g=t(h,n).get(0);switch(a.action){case"depth":d.value=t(".indentation",t(g).closest("tr")).length;break;case"match":d.value=g.value;break;case"order":var c=this.rowObject.findSiblings(a);if(t(d).is("select")){var p=[];t("option",d).each(function(){p.push(this.value)});var u=p[p.length-1];t(s,c).each(function(){p.length>0?this.value=p.shift():this.value=u})}else{var b=parseInt(t(s,c[0]).val(),10)||0;t(s,c).each(function(){this.value=b,b++})}}}},Drupal.tableDrag.prototype.copyDragClasses=function(e,r,a){var n=t("."+a,e),i=t("."+a,r);n.length&&i.length&&(i[0].className=n[0].className)},Drupal.tableDrag.prototype.checkScroll=function(t){var e=document.documentElement,r=document.body,a=this.windowHeight=window.innerHeight||(e.clientHeight&&0!=e.clientWidth?e.clientHeight:r.offsetHeight),n=this.scrollY=document.all?e.scrollTop?e.scrollTop:r.scrollTop:window.pageYOffset?window.pageYOffset:window.scrollY,i=this.scrollSettings.trigger,o=0;return t-n>a-i?(o=i/(a+n-t),o=o>0&&o<i?o:i,o*this.scrollSettings.amount):t-n<i?(o=i/(t-n),o=o>0&&o<i?o:i,-o*this.scrollSettings.amount):void 0},Drupal.tableDrag.prototype.setScroll=function(t){var e=this;this.scrollInterval=setInterval(function(){e.checkScroll(e.currentMouseCoords.y);var r=e.scrollY>e.table.topY,a=e.scrollY+e.windowHeight<e.table.bottomY;(t>0&&a||t<0&&r)&&window.scrollBy(0,t)},this.scrollSettings.interval)},Drupal.tableDrag.prototype.restripeTable=function(){t("> tbody > tr.draggable:visible, > tr.draggable:visible",this.table).removeClass("odd even").filter(":odd").addClass("even").end().filter(":even").addClass("odd")},Drupal.tableDrag.prototype.onDrag=function(){return null},Drupal.tableDrag.prototype.onDrop=function(){return null},Drupal.tableDrag.prototype.row=function(e,r,a,n,i){if(this.element=e,this.method=r,this.group=[e],this.groupDepth=t(".indentation",e).length,this.changed=!1,this.table=t(e).closest("table").get(0),this.indentEnabled=a,this.maxDepth=n,this.direction="",this.indentEnabled){this.indents=t(".indentation",e).length,this.children=this.findChildren(i),this.group=t.merge(this.group,this.children);for(var o=0;o<this.group.length;o++)this.groupDepth=Math.max(t(".indentation",this.group[o]).length,this.groupDepth)}},Drupal.tableDrag.prototype.row.prototype.findChildren=function(e){for(var r=this.indents,a=t(this.element,this.table).next("tr.draggable"),n=[],i=0;a.length;){var o=t(".indentation",a).length;if(!(o>r))break;i++,n.push(a[0]),e&&t(".indentation",a).each(function(e){1==i&&e==r&&t(this).addClass("tree-child-first"),e==r?t(this).addClass("tree-child"):e>r&&t(this).addClass("tree-child-horizontal")}),a=a.next("tr.draggable")}return e&&n.length&&t(".indentation:nth-child("+(r+1)+")",n[n.length-1]).addClass("tree-child-last"),n},Drupal.tableDrag.prototype.row.prototype.isValidSwap=function(e){if(this.indentEnabled){var r,a;if("down"==this.direction?(r=e,a=t(e).next("tr").get(0)):(r=t(e).prev("tr").get(0),a=e),this.interval=this.validIndentInterval(r,a),this.interval.min>this.interval.max)return!1}return this.table.tBodies[0].rows[0]!=e||!t(e).is(":not(.draggable)")},Drupal.tableDrag.prototype.row.prototype.swap=function(e,r){Drupal.detachBehaviors(this.group,Drupal.settings,"move"),t(r)[e](this.group),Drupal.attachBehaviors(this.group,Drupal.settings),this.changed=!0,this.onSwap(r)},Drupal.tableDrag.prototype.row.prototype.validIndentInterval=function(e,r){var a,n;return a=r?t(".indentation",r).length:0,!e||t(e).is(":not(.draggable)")||t(this.element).is(".tabledrag-root")?n=0:(n=t(".indentation",e).length+(t(e).is(".tabledrag-leaf")?0:1),this.maxDepth&&(n=Math.min(n,this.maxDepth-(this.groupDepth-this.indents)))),{min:a,max:n}},Drupal.tableDrag.prototype.row.prototype.indent=function(e){if(!this.interval){var r=t(this.element).prev("tr").get(0),a=t(this.group).filter(":last").next("tr").get(0);this.interval=this.validIndentInterval(r,a)}var n=this.indents+e;n=Math.max(n,this.interval.min),n=Math.min(n,this.interval.max),e=n-this.indents;for(var i=1;i<=Math.abs(e);i++)e<0?(t(".indentation:first",this.group).remove(),this.indents--):(t("td:first",this.group).prepend(Drupal.theme("tableDragIndentation")),this.indents++);return e&&(this.changed=!0,this.groupDepth+=e,this.onIndent()),e},Drupal.tableDrag.prototype.row.prototype.findSiblings=function(e){for(var r=[],a=["prev","next"],n=this.indents,i=0;i<a.length;i++){for(var o=t(this.element)[a[i]]();o.length&&t("."+e.target,o);){if(this.indentEnabled)var l=t(".indentation",o).length;if(this.indentEnabled&&l!=n){if(l<n)break}else r.push(o[0]);o=t(o)[a[i]]()}"prev"==a[i]&&(r.reverse(),r.push(this.element))}return r},Drupal.tableDrag.prototype.row.prototype.removeIndentClasses=function(){for(var e in this.children)t(".indentation",this.children[e]).removeClass("tree-child").removeClass("tree-child-first").removeClass("tree-child-last").removeClass("tree-child-horizontal")},Drupal.tableDrag.prototype.row.prototype.markChanged=function(){var e=Drupal.theme("tableDragChangedMarker"),r=t("td:first",this.element);0==t("span.tabledrag-changed",r).length&&r.append(e)},Drupal.tableDrag.prototype.row.prototype.onIndent=function(){return null},Drupal.tableDrag.prototype.row.prototype.onSwap=function(t){return null},Drupal.theme.prototype.tableDragChangedMarker=function(){return'<span class="warning tabledrag-changed">*</span>'},Drupal.theme.prototype.tableDragIndentation=function(){return'<div class="indentation">&nbsp;</div>'},Drupal.theme.prototype.tableDragChangedWarning=function(){return'<div class="tabledrag-changed-warning messages warning">'+Drupal.theme("tableDragChangedMarker")+" "+Drupal.t("Changes made in this table will not be saved until the form is submitted.")+"</div>"}}(jQuery);
